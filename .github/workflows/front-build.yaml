name: Front Build

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'front/**'
      - '.github/workflows/front-build.yaml'
      - '.github/actions/setup-node/**'
      - 'Makefile'
  workflow_dispatch:
  merge_group:
     branches: ['main']

env:
  FRONT_FOLDER: ./front

jobs:
  install:
    name: Install package
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup Node
        uses: ./.github/actions/setup-node

      - name: Check package-lock.json
        working-directory: ${{ env.FRONT_FOLDER }}
        run: npm run package:check

      - name: Install package
        working-directory: ${{ env.FRONT_FOLDER }}
        run: npm ci
        
  lint:
    name: Lint code
    needs:
      - install
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup Node
        uses: ./.github/actions/setup-node

      - name: Run lint
        working-directory: ${{ env.FRONT_FOLDER }}
        run: npm run lint

  test:
    name: Test
    needs:
      - install
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup Node
        uses: ./.github/actions/setup-node
      
      - name: Run Playwright install
        working-directory: ${{ env.FRONT_FOLDER }}
        run: npx playwright install

      - name: Run test
        working-directory: ${{ env.FRONT_FOLDER }}
        run: npm run test

  build:
    name: Build
    needs:
      - install
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup Node
        uses: ./.github/actions/setup-node

      - name: Run build
        working-directory: ${{ env.FRONT_FOLDER }}
        run: npm run build

  storybook-build:
    name: Build Storybook
    needs:
      - install
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup Node
        uses: ./.github/actions/setup-node

      - name: Run build
        working-directory: ${{ env.FRONT_FOLDER }}
        run: npm run build:storybook

  chromatic:
    name: Run Chromatic
    needs:
      - storybook-build
    if: ${{ github.event_name == 'pull_request' && github.event.pull_request.base.ref == 'main' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Filter changed paths
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            ui:
              - 'front/src/ui/**'

      - name: Setup Node (only when UI changed)
        if: steps.changes.outputs.ui == 'true'
        uses: ./.github/actions/setup-node

      - name: Run Chromatic
        if: steps.changes.outputs.ui == 'true'
        uses: chromaui/action@latest
        with:
          buildScriptName: "build:storybook"
          workingDir: "front"
          onlyChanged: true
          zip: true
          projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
